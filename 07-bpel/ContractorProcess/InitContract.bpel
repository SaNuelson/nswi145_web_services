<!-- InitContract BPEL Process [Generated by the Eclipse BPEL Designer] -->
<!-- Date: Sat Apr 02 23:09:28 CEST 2022 -->
<bpel:process name="InitContract"
    targetNamespace="http://contractor/"
    suppressJoinFailure="yes"
    xmlns:tns="http://contractor/"
    xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
    xmlns:ns="http://webinterface/"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

    <bpel:partnerLinks>

        <!-- Link for communication with client -->
        <bpel:partnerLink name="ContractInitLink"
            partnerLinkType="tns:ContractInitLinkType"
            myRole="InitExecutorRole" />

        <!-- Link for Contractor.FreelancerAccessPoint -->
        <bpel:partnerLink name="FreelancersAPLink"
            partnerLinkType="tns:FreelancerAccessPointLinkType"
            partnerRole="InfoProviderRole"
            myRole="InfoRequisitorRole"></bpel:partnerLink>

        <!-- Link for Contractor.ContractAccessPoint -->
        <bpel:partnerLink name="ContractsAPLink"
            partnerLinkType="tns:ContractAccessPointLinkType"
            partnerRole="InfoProviderRole"
            myRole="InfoRequisitorRole"></bpel:partnerLink>

    </bpel:partnerLinks>

    <!-- Import the client WSDL -->
    <bpel:import location="InitContractArtifacts.wsdl" namespace="http://contractor/"
        importType="http://schemas.xmlsoap.org/wsdl/" />

    <!-- ================================================================= -->
    <!-- ORCHESTRATION LOGIC                                               -->
    <!-- Set of activities coordinating the flow of messages across the    -->
    <!-- services integrated within this business process                  -->
    <!-- ================================================================= -->
    <bpel:variables>

        <!-- Client provides contract which should be submitted -->
        <bpel:variable name="ContractInput" messageType="ns:submitContract"></bpel:variable>

        <!-- Client receives info about submitting success -->
        <bpel:variable name="SuccessOutput" messageType="ns:submitContractResponse"></bpel:variable>

        <!-- Request & receive IDs of freelancer able to do the job -->
        <bpel:variable name="CompatibleFreelancersLinkRequest" messageType="ns:getCompatibleFreelancers"></bpel:variable>
        <bpel:variable name="CompatibleFreelancersLinkResponse" messageType="ns:getCompatibleFreelancersResponse"></bpel:variable>

        <!-- Global var holding the info about best freelancer for the job -->
        <bpel:variable name="BestFreelancer" element="ns:getFreelancerDetailsResponse"></bpel:variable>

    </bpel:variables>


    <bpel:sequence name="InitiateContract">

        <!-- For received contract info, find compatible freelancers -->
        <bpel:assign validate="no" name="AssignJobTypeToFAPRequest">

            <bpel:copy>
                <bpel:from>
                    <bpel:literal xml:space="preserve">
                        <ns:getCompatibleFreelancers>
                            <jobType>jobType</jobType>
                        </ns:getCompatibleFreelancers>
                    </bpel:literal>
                </bpel:from>
                <bpel:to variable="CompatibleFreelancersLinkRequest" part="parameters"></bpel:to>
            </bpel:copy>

            <bpel:copy>
                <bpel:from variable="ContractInput">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[arg0/jobType]]>
                    </bpel:query>
                </bpel:from>
                <bpel:to part="parameters" variable="CompatibleFreelancersLinkRequest">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[jobType]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>

        </bpel:assign>

        <bpel:invoke name="InvokeGetCompatibleFreelancers" partnerLink="FreelancersAPLink" operation="getCompatibleFreelancers" portType="ns:FreelancerAccessPoint" inputVariable="CompatibleFreelancersLinkRequest" outputVariable="CompatibleFreelancersLinkResponse"></bpel:invoke>

        <!-- For each compatible freelancer, get details and pick best (cheapest) -->

        <bpel:forEach parallel="yes" counterName="i">

            <bpel:startCounterValue>
                1
            </bpel:startCounterValue>
            <bpel:finalCounterValue>
                count($CompatibleFreelancersLinkResponse/getCompatibleFreelancersResponse/freelancerIds)
            </bpel:finalCounterValue>

            <bpel:scope>
                <bpel:variables>

                    <bpel:variable name="FreelancerDetailsRequest" messageType="ns:getFreelancerDetails">
                        <bpel:from>
                            <bpel:literal xml:space="preserve">
                                <ns:getFreelancerDetails>
                                    <freelancerId>0</freelancerId>
                                </ns:getFreelancerDetails>
                            </bpel:literal>
                        </bpel:from>
                    </bpel:variable>

                    <bpel:variable name="FreelancerDetailsResponse" messageType="ns:getFreelancerDetailsResponse">
                        <bpel:from>
                            <bpel:literal xml:space="preserve">
                                <ns:getFreelancerDetailsResponse>
                                    <freelancerInfo>
                                        <hourlyRate>0</hourlyRate>
                                        <id>0</id>
                                        <jobTypes>0</jobTypes>
                                        <name>0</name>
                                    </freelancerInfo>
                                </ns:getFreelancerDetailsResponse>
                            </bpel:literal>
                        </bpel:from>
                    </bpel:variable>

                </bpel:variables>

                <bpel:sequence>

                    <bpel:assign validate="no">

                        <bpel:copy>

                            <bpel:from variable="CompatibleFreelancersLinkResponse">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[freelancerIds[i]]]>
                                </bpel:query>
                            </bpel:from>

                            <bpel:to variable="FreelancerDetailsRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[freelancerId]]>
                                </bpel:query>
                            </bpel:to>

                        </bpel:copy>

                    </bpel:assign>

                    <bpel:invoke
                        name="InvokeGetFreelancerInfo"
                        partnerLink="FreelancersAPLink"
                        operation="getFreelancerDetails"
                        portType="ns:FreelancerAccessPoint"
                        inputVariable="FreelancerDetailsRequest"
                        outputVariable="FreelancerDetailsResponse" />

                    <bpel:if name="IfBetter">
                        <bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                            <![CDATA[$FreelancerDetailsResponse//hourlyRate < $BestFreelancer//hourlyRate]]>
                        </bpel:condition>
                        <bpel:assign validate="no" name="AssignBetterFlc">
                            <bpel:copy>
                                <bpel:from variable="FreelancerDetailsResponse" part="parameters"></bpel:from>
                                <bpel:to variable="BestFreelancer"></bpel:to>
                            </bpel:copy>
                        </bpel:assign>
                    </bpel:if>
                </bpel:sequence>
            </bpel:scope>
        </bpel:forEach>

        <bpel:assign validate="no" name="AssignBestFlc">
            <bpel:copy>
                <bpel:from variable="BestFreelancer">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[id]]>
                    </bpel:query>
                </bpel:from>
                <bpel:to variable="ContractInput">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[arg0/freelancerId]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>
        </bpel:assign>

        <bpel:invoke name="InvokeSubmitContract"
            partnerLink="ContractsAPLink"
            operation="submitContract"
            portType="ns:ContractAccessPoint"
            inputVariable="ContractInput"
            outputVariable="SuccessOutput" />
    </bpel:sequence>
</bpel:process>